define("commissionFinder",["jquery","underscore","errorCode","common","alimama","configInBackground","commissionInCampaign","qtkApi"],function(a,b,c,d,e,f,g,h){return function(){function b(a){this.context=a,this.campaignIdRateMap=null,this.campaignList=null,this.exsitApplyList=null,this.generalCommission=null,this.commissionRates=[],this.hiddenPlan=[],this.commission=null}return b.prototype.start=function(){return this.findGeneralCommission(),this.findMagpieCommission(),this.checkQueQiao()},b.prototype.findGeneralCommission=function(){var b,c,f,g;return f=this,c=f.context.reTmallorTaobaoGoodID(),a(".qtkMenuLink").attr("href","http://pub.alimama.com/promo/search/index.htm?queryType=2&q=https%3A%2F%2Fdetail.tmall.com%2Fitem.htm%3Fid%3D"+c+"&yxjh=-1"),b=new e,g=b.searchAuction(c),g.fail(function(b){return d.log("fail in findGeneralCommission"),a("div.qtk_bg_div_three").find("tbody>tr:first").empty().append('<td colspan="4" class="reload">\u8bbf\u95ee\u8fc7\u591a\uff0c\u88ab\u6dd8\u5b9d\u9650\u5236\uff0c\u8bf7<a href="javascript:window.location.reload();">\u5237\u65b0\u91cd\u8bd5</td>')}),g.done(function(a){return function(a){return null==a&&(a={calCommission:0,totalFee:0,saleNum:0,commissionRate:0,commission:0,userNumberId:null,eventRate:0,tkRate:0}),f.generalCommission=a.tkRate,a.tkRate?(f.context.detail.commissionRate=a.tkRate+"%",f.context.detail.commission="&yen;"+a.tkCommFee):(f.context.detail.commissionRate="\u6682\u65e0",f.context.detail.commission=""),f.context.detail.totalFee=a.totalFee,f.context.detail.saleNum=a.totalNum,f.context.detail.userNumberId=a.sellerId,f.campaignIdRateMap=a.tkSpecialCampaignIdRateMap,a.eventRate?f.context.detail.eventRate=a.eventRate+"%":f.context.detail.eventRate="\u6682\u65e0",f.findPlanCommission()}}())},b.prototype.findMagpieCommission=function(){var a,b,c,d;return d=this,c=d.context.reTmallorTaobaoGoodID(),a=new e,b=a.magpieDetail(c),b.fail(function(){return console.log(arguments)}),b.done(function(a){return null===a?(d.context.detail.highCommissionMagpie=null,void(d.context.detail.eventRate="\u6682\u65e0")):(a.fenCheng=100-a.tk3rdRate,a.zhongfen=Math.round(a.eventRate*a.fenCheng)/100,a.commission=Math.round(a.zkPrice*a.zhongfen)/100,a.buySelf=Math.round(100*(a.zkPrice-.87*a.commission))/100,a.url=encodeURIComponent(a.auctionUrl),d.context.detail.highCommissionMagpie=a)})},b.prototype.findPlanCommission=function(){var a,b,c;return a=this,a.context.reTmallorTaobaoGoodID(),c=a.context.reTmallorTaobaoUserID(),b=a.getCampaignList(c),b.then(function(b){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;if(null===(g=b.campaignList))return a.campaignList=[],void a.showCampaignList();for(j=i=0,o=g.length;i<o;j=++i)e=g[j],g[j].userNumberId=c,g[j].avgCommissionToString=parseFloat(e.avgCommissionToString.replace(/(\s+|%)/gi,""));if(g.length>0)for(j=l=0,p=g.length;l<p;j=++l)if(e=g[j],0!==e.campaignId){if(null!==a.campaignIdRateMap&&void 0!==a.campaignIdRateMap){t=a.campaignIdRateMap;for(f in t)s=t[f],(f+="")===e.campaignId+""&&(g[j].rateInCampaign=parseFloat(s),k={P:g[j].properties,R:g[j].rateInCampaign},a.commissionRates.push(k))}}else g[j].rateInCampaign=a.generalCommission,a.processMaxCommission(1,a.generalCommission);if(a.processMaxCommission(),h=b.exsitApplyList||null,g.length>0&&null!==h)for(m=0,q=h.length;m<q;m++)for(d=h[m],j=n=0,r=g.length;n<r;j=++n)e=g[j],e.campaignId===d.campaignId&&(g[j].applyDetail=d,g[j].applyStatus=d.status);return a.campaignList=g,a.exsitApplyList=b.exsitApplyList,a.showCampaignList(),a.findHiddenPlanCommission(),a.showNotLogin()}).catch(function(b){return"nologin"===b.errorText?a.showNotLogin():a.showNoPlans()})},b.prototype.findHiddenPlanCommission=function(){var a,b,c,d;return b=this,b.hiddenPlan=null,d=b.context.reTmallorTaobaoUserID(),c=new h,a=c.testUserPlan({},d),a.done(function(a){var c,d,e,f;if(null===b.campaignIdRateMap||void 0===b.campaignIdRateMap)return!1;for(f=[],c=0,e=a.length;c<e;c++)d=a[c],null==b.campaignIdRateMap[d.campaignId]?f.push(b.processOneHiddenPlanCommission(d)):f.push(void 0);return f})},b.prototype.processOneHiddenPlanCommission=function(a){var b,c,d,f;return c=a,f=this,b=new e,d=b.getHidePlanInformation(c.campaignId,c.shopKeeperId,c.userNumberId),d.then(function(b){var d,e,g,h,i,j,k;if(b.catCommissions&&!(b.catCommissions.length<1)){if(d=b.cpsCampaignDO.campaignId,f.exsitApplyList&&f.exsitApplyList.length>0)for(j=f.exsitApplyList,g=0,h=j.length;g<h;g++)a=j[g],a.campaignId===d&&(1!==a.status&&2!==a.status||(k=a.status,e={id:a.id}));return i={type:1,campaignId:d,shopKeeperId:c.shopKeeperId,userNumberId:c.userNumberId,campaignName:b.cpsCampaignDO.campaignName,properties:b.cpsCampaignDO.properties,applyStatus:k||void 0,applyDetail:e||void 0},f.campaignList.push(i),f.context.detail.campaigns=f.campaignList,f.fixCommissionInOneCampaign(i)}})},b.prototype.findCommissionRateMax=function(){var a,b,c,d,e,f;for(e=0,0,f=this.commissionRates,b=a=0,d=f.length;a<d;b=++a)c=f[b],0===b?(e=c.R,c.R):1===c.P&&(c.R>e?e=c.R:c.R);return e},b.prototype.checkQueQiao=function(){var a,b,c;return c=this,a=new f,b=a.get("isDefaultShowOld"),b.done(function(a){if("1"===a)return c.findQueQiao()})},b.prototype.findQueQiao=function(){return a(".qtk_bg_old_magpie").show(),this.context.magpieSearchList()},b.prototype.showCampaignList=function(){var a;return a=this,a.context.detail.campaigns=a.campaignList,a.fixCommissionInCampaign(),a.processMaxCommission()},b.prototype.fixCommissionInCampaign=function(){var a,b,c,d,e,f;if(d=this,null!==(e=d.context.detail.campaigns)){for(f=[],b=0,c=e.length;b<c;b++)a=e[b],"0"!==String(a.campaignId)&&void 0===a.rateInCampaign&&f.push(d.fixCommissionInOneCampaign(a));return f}},b.prototype.fixCommissionInOneCampaign=function(a){var b,c,d,e,f;return c=a.properties,f=this,e=f.context.reTmallorTaobaoGoodID(),b=new g(a.campaignId,a.shopKeeperId,a.userNumberId),d=b.get(e),d.fail(function(){return f.showFixedCommissionInCampaign(a.campaignId,null)}),d.done(function(b){return null===b?void f.showFixedCommissionInCampaign(a.campaignId,null):(f.showFixedCommissionInCampaign(a.campaignId,b.commissionRatePercent),f.processMaxCommission(c,b.commissionRatePercent))})},b.prototype.showFixedCommissionInCampaign=function(a,b){var c,d,e,f,g,h;if(g=this,null!==(h=g.context.detail.campaigns)){for(e=d=0,f=h.length;d<f;e=++d)c=h[e],String(c.campaignId)===String(a)&&g.context.VueFunction.set(h[e],"rateInCampaign",parseFloat(b));return g.context.detail.campaigns=h}},b.prototype.getCampaignList=function(a){var b;return b=new e,new Promise(function(c,d){var f;return b=new e,f=b.getCampaignList(a),f.fail(function(a){return d(a)}),f.done(function(a){return c(a)})})},b.prototype.applyCampaign=function(a,b){var c,d,g;return g=this,c=new f,d=c.get("reason"),d.done(function(c){var d,f;return c=c||"",c.length<1&&(c="\u8f7b\u6dd8\u5ba2\u91d1\u51a0\u8054\u76df\u6210\u5458\u7533\u8bf7\u63a8\u5e7f\u8ba1\u5212\uff0c\u671b\u8d35\u5e97\u901a\u8fc7\uff0c\u795d\u5408\u4f5c\u6109\u5feb\uff01\u8c22\u8c22"),d=new e,f=d.applyCampaign(a,b,c),f.always(function(){return g.findPlanCommission()})})},b.prototype.exitCampaign=function(a){var b,c,d;return d=this,b=new e,c=b.exitCampaign(a),c.always(function(){return d.findPlanCommission()})},b.prototype.showNotLogin=function(){return a("#qtk_campaign_empty td").html('\u6ca1\u6709\u767b\u5f55\u6dd8\u5b9d\u8054\u76df\u6216\u5df2\u9000\u51fa\u6dd8\u5b9d\u8054\u76df\u3002<br/><a target="_blank" href="http://www.alimama.com/member/login.htm">\u70b9\u6211\u53bb\u767b\u5f55\u6dd8\u5b9d\u8054\u76df</a>')},b.prototype.showNoPlans=function(){return a("#qtk_campaign_empty td").html("\u6682\u65e0\u5b9a\u5411\u8ba1\u5212")},b.prototype.bindButtons=function(){var b;return b=this,a(document).on("click",".qtkUserOutTask",function(){var c,f,g,h,i;return g=a(this),i=g.parent("td"),f=g.attr("data-att"),c=new e,h=c.userOutTask(f),h.fail(function(a){return b.context.layer.msg("\u9000\u51fa\u5931\u8d25")}),h.done(function(a){return d.log(a),i.html('<button onclick="javascript:window.location.href=location.href;" >\u5237\u65b0</button>'),b.context.layer.alert("\u64cd\u4f5c\u6210\u529f",{icon:1})})})},b.prototype.processMaxCommission=function(){var a,b;return b=this,arguments.length>0&&(a={P:arguments[0],R:arguments[1]},b.commissionRates.push(a)),b.context.detail.commissionRateMax=b.findCommissionRateMax(),b.context.detail.commissionMax=Math.round(b.findCommissionRateMax()*(b.context.reTmallorTaobaoGoodPrice()-b.context.coupon.findTheMaxCouponPrice()))/100},b}()});