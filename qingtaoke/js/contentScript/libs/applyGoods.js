define("applyGoods",["jquery","underscore","alimama"],function(a,b,c){return function(){function d(b){this.reason=b,this.alimama=new c,this.dtd=a.Deferred(),this.index=0,this.result=[]}return d.prototype.runApply=function(a){return this.gid=a,this.getUserNumId(),this.dtd},d.prototype.getUserNumId=function(){var a;return a=this.alimama.goodsDetail(this.gid),a.fail(function(a){return function(b){return a.dtd.reject({gid:a.gid,e:b})}}(this)),a.done(function(a){return function(b){return a.goods=b.itemInfoModel,a.seller=b.seller,a.onGetUserNumId(b.seller.userNumId)}}(this))},d.prototype.onGetUserNumId=function(a){var b;return b=this.alimama.getCampaignList(a),b.fail(function(a){return function(b){return a.dtd.reject({gid:a.gid,e:b})}}(this)),b.done(function(a){return function(b){return a.onGetCampaignList(b.campaignList)}}(this))},d.prototype.onGetCampaignList=function(a){var c,d,e,f,g,h,i,j,k,l,m,n;if(this.campaignList=a,!b.isArray(this.campaignList))return this.dtd.reject({gid:this.gid,e:1}),!1;for(l=this.campaignList,g=f=0,j=l.length;f<j;g=++f)for(c=l[g],m=this.campaignList,h=i=0,k=m.length;i<k;h=++i)d=m[h],d.avgCommission>c.avgCommission&&(n=this.campaignList[g],this.campaignList[g]=this.campaignList[h],this.campaignList[h]=n);return this.index=0,1===this.campaignList.length&&(e=this.campaignList[0],0===e.campaignId)?(this.dtd.reject({gid:this.gid,e:1}),!1):this.applyCampaign()},d.prototype.applyCampaign=function(){var a,b;return this.index>=this.campaignList.length?(this.dtd.resolve(this.result),!0):(a=this.campaignList[this.index],0===a.campaignId?(this.index++,this.applyCampaign(),!0):(b=this.alimama.applyCampaign(a.campaignId,a.shopKeeperId,this.reason),b.fail(function(a){return function(b){return a.index++,a.applyCampaign()}}(this)),b.done(function(b){return function(c){return b.dtd.notify({gid:b.gid,detail:b.goods,seller:b.seller,result:c,campaign:a}),b.result.push(c),b.index++,b.applyCampaign()}}(this))))},d}()});