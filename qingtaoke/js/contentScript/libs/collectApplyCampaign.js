define("collectApplyCampaign",["jquery","underscore","layer","common","config","configInBackground","applyCampaign","qtkApi"],function(a,b,c,d,e,f,g,h){return function(){function b(){this.bindEvent(),this.isApplying=!1}return b.prototype.bindEvent=function(){return a(document).on("click",".apply-selected",function(a){return function(){var b;return b=a.checkStatus(),b.done(function(){return a.onApplySelected()})}}(this)),a(document).on("click",".apply-all",function(a){return function(){var b;return b=a.checkStatus(),b.done(function(){return a.onApplyAll()})}}(this)),a(document).on("click","#apply-campaign-button",function(a){return function(){return a.onApplyStart()}}(this)),a(window).on("beforeunload",function(a){return function(){return a.onBeforeUnload()}}(this))},b.prototype.checkStatus=function(){var b,d,e;return e=a.Deferred(),b=new f,d=a.when(b.get("isLoginAlimama"),b.get("isValid"),b.get("isUnavailable")),d.done(function(a){return function(a,b,d){return d?(c.alert('\u60a8\u4f7f\u7528\u7684\u8f7b\u6dd8\u5ba2\u65d7\u8230\u7248\u7248\u672c\u592a\u8001\u5566\u3002<a target="_blank" style="color: #f40;" href="">\u70b9\u6211\u53bb\u4e0b\u8f7d\u65b0\u7248</a>'),e.reject("isUnavailable"),!0):a?e.resolve(!0):(c.alert('\u8bf7\u767b\u5f55\u6dd8\u5b9d\u8054\u76df\u3002<a target="_blank" style="color: #f40;" href="http://www.alimama.com">\u7acb\u5373\u767b\u5f55</a>'),e.reject("isLoginAlimama"),!0)}}()),e},b.prototype.onApplySelected=function(){var b,d,e,f;if(this.isApplying)return this.applyCampaign&&this.applyCampaign.restore(),!0;for(e=a("input.selected-goods:checked"),this.gidList=[],b=0,d=e.length;b<d;b++)f=e[b],this.gidList.push(a(f).attr("data-gid"));return this.gidList.length<1?(c.alert("\u8bf7\u9009\u62e9\u5546\u54c1!"),!0):this.openReasonLayer("selected")},b.prototype.openReasonLayer=function(b){var d,e;return d=new f,e=d.get("reason"),e.done(function(b){return function(d){var e,f;return b.applyReasonLayerIndex&&c.close(b.applyReasonLayerIndex),d||(d=""),f="<div style='display: none' id='qtk_flagship_apply_reason'><div class='title'>\u7533\u8bf7\u7406\u7531\uff1a</div><div class='reason-bar'><textarea name='apply-reason' id='apply-reason'>"+d+"</textarea></div> <div class='apply-button'><button id='apply-campaign-button'>\u5f00\u59cb\u7533\u8bf7</button></div> </div>",e=a("#qtk_flagship_apply_reason"),e.length<1&&a("body").append(f),b.applyReasonLayerIndex=c.open({type:1,title:"\u7533\u8bf7\u63a8\u5e7f\u8ba1\u5212\u539f\u56e0\u8bbe\u7f6e",content:a("#qtk_flagship_apply_reason"),closeBtn:!0,shade:!1,area:["800px","350px"],shift:2,maxmin:!0,success:function(){},end:function(){return b.applyReasonLayerIndex=null}})}}(this))},b.prototype.onApplyStart=function(){var b,e,f,i;return i=a("#apply-reason").val(),i=i.replace(/(^\s*|\s*$)/gi,""),(e=d.getStringLength(i))>200?(c.tips("\u7533\u8bf7\u7406\u7531\u4e0d\u80fd\u8d85\u8fc7200\u4e2a\u5b57\u7b26(100\u4e2a\u6c49\u5b57)",a("#apply-reason"),{time:4e3}),!0):e<1?(c.tips("\u5fc5\u987b\u586b\u5199\u7533\u8bf7\u7406\u7531",a("#apply-reason"),{time:4e3}),!0):(c.close(this.applyReasonLayerIndex),f=new h,f.saveReason(i),this.applyCampaign=new g(this.gidList,i),this.isApplying=!0,b=this.applyCampaign.runApply(),b.progress(function(a){return function(b){return a.onProgress(b)}}(this)),b.done(function(a){return function(b){return a.onFinish(b)}}(this)))},b.prototype.onApplyAll=function(){var a,b,d;return this.isApplying&&this.applyCampaign?(this.applyCampaign.restore(),!0):(b=c.msg("\u52a0\u8f7d\u5546\u54c1\u6570\u636e\u4e2d\u2026\u2026",{time:0}),d=new h,a=d.getCollectedGid(),a.fail(function(){return c.close(b),c.alert("\u52a0\u8f7d\u5546\u54c1\u6570\u636e\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5!")}),a.done(function(a){return function(d){return c.close(b),d.length<1?(c.alert("\u6ca1\u6709\u9700\u8981\u7533\u8bf7\u63a8\u5e7f\u8ba1\u5212\u7684\u5546\u54c1"),!0):d.length>=500?(c.alert("\u9700\u8981\u7533\u8bf7\u63a8\u5e7f\u8ba1\u5212\u7684\u5546\u54c1\u8f83\u591a\uff0c\u7533\u8bf7\u65f6\u95f4\u4f1a\u6bd4\u8f83\u4e45",function(){return a.onGetAllGid(d)}),!0):a.onGetAllGid(d)}}(this)))},b.prototype.onProgress=function(a){},b.prototype.onFinish=function(a){return this.isApplying=!1,this.applyCampaign=null},b.prototype.onBeforeUnload=function(){if(this.isApplying)return"\u6b63\u5728\u7533\u8bf7\u63a8\u5e7f\u8ba1\u5212\u4e2d"},b.prototype.onGetAllGid=function(a){return this.gidList=a,this.openReasonLayer("all")},b}()});